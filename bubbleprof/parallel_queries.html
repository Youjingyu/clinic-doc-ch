<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并行查询</title>
    <meta name="description" content="Node Clinic 中文文档">
    <link rel="shortcut icon" href="/clinic-doc-zh/icon.png">
  <style>
      p + blockquote, ol + blockquote,  ul + blockquote {
        display: none;
      }
    </style>
  <script>
      document.addEventListener('click', function (e) {
        var target = e.target
        var nextSibling
        if (target.tagName === 'P') {
          nextSibling = target.nextElementSibling
        } else if (target.tagName === 'LI') {
          nextSibling = target.parentNode.nextElementSibling
        }
        if (nextSibling && nextSibling.tagName === 'BLOCKQUOTE') {
          var hide = 'display:none'
          var show = 'display:block'
          var style = nextSibling.getAttribute('style')
          nextSibling.setAttribute('style', style === show ? hide : show)
        }
      })
    </script>
  <script>
      var logoUrlChanger = setInterval(function () {
        // Anchor above the logo image
        var homeEls = document.getElementsByClassName('home-link')
        if (homeEls.length > 0) {
          var homeEl = homeEls[0]
          homeEl.setAttribute('href', 'https://clinicjs.org/documentation')
          homeEl.setAttribute('onclick', "document.location='https://clinicjs.org/documentation';return false;")
          clearInterval(logoUrlChanger)
        }

        // Actual logo image
        var logoEls = document.getElementsByClassName('logo')
        if (logoEls.length > 0) {
          var logoEl = logoEls[0]
          logoEl.setAttribute('onclick', "document.location='https://clinicjs.org/documentation';return false;")
          clearInterval(logoUrlChanger)
        }
      }, 1000)
    </script>
    
    <link rel="preload" href="/clinic-doc-zh/assets/css/0.styles.feea2165.css" as="style"><link rel="preload" href="/clinic-doc-zh/assets/js/app.75a44ac4.js" as="script"><link rel="preload" href="/clinic-doc-zh/assets/js/10.b505e73e.js" as="script"><link rel="prefetch" href="/clinic-doc-zh/assets/js/11.032e2525.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/12.19c3aee9.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/13.9082d8b6.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/14.c6f29cca.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/15.b41e31f0.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/16.841d9223.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/17.55afc7db.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/18.f63d344f.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/19.11585fc4.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/2.e5f43561.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/20.47b55fca.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/21.9cdae012.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/22.39d2389b.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/23.2fb2fbba.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/24.1bf5b85a.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/25.4cb5b678.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/26.7f5c2c15.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/27.23216170.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/28.1707d2c7.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/29.7c788ded.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/3.a472746a.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/30.1382df70.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/31.8f6973e1.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/4.7a3df476.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/5.d84f4001.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/6.4af6163d.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/7.91d6fdd6.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/8.c444e8be.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/9.fcb1f222.js">
    <link rel="stylesheet" href="/clinic-doc-zh/assets/css/0.styles.feea2165.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/clinic-doc-zh/" class="home-link router-link-active"><img src="/clinic-doc-zh/logo.png" alt="" class="logo"> <!----></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/Youjingyu/clinic-doc-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/Youjingyu/clinic-doc-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/clinic-doc-zh/" class="sidebar-link">开始</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Doctor</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Flame</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Bubbleprof</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/clinic-doc-zh/bubbleprof/preface.html" class="sidebar-link">前言</a></li><li><a href="/clinic-doc-zh/bubbleprof/setup.html" class="sidebar-link">安装</a></li><li><a href="/clinic-doc-zh/bubbleprof/getting_ready.html" class="sidebar-link">准备</a></li><li><a href="/clinic-doc-zh/bubbleprof/first_analysis.html" class="sidebar-link">首次分析</a></li><li><a href="/clinic-doc-zh/bubbleprof/bubbles.html" class="sidebar-link">Bubbles（气泡）</a></li><li><a href="/clinic-doc-zh/bubbleprof/the_sidebar.html" class="sidebar-link">侧边栏</a></li><li><a href="/clinic-doc-zh/bubbleprof/finding_the_first_bottleneck.html" class="sidebar-link">寻找第一个瓶颈</a></li><li><a href="/clinic-doc-zh/bubbleprof/improving_our_latency.html" class="sidebar-link">改善延迟</a></li><li><a href="/clinic-doc-zh/bubbleprof/parallel_queries.html" class="active sidebar-link">并行查询</a></li><li><a href="/clinic-doc-zh/bubbleprof/caching_the_results.html" class="sidebar-link">缓存结果</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="并行查询"><a href="#并行查询" aria-hidden="true" class="header-anchor">#</a> 并行查询</h1> <p>第三个示例，<code>3-server-with-index-in-parallel.js</code> 与第二个示例类似，但是并行执行查询。我们再次分析一下。</p> <blockquote><p>The third example, 3-server-with-index-in-parallel.js is similar to second example, but executes the queries in parallel. Let's profile it again.</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>clinic bubbleprof --on-port <span class="token string">'autocannon -c 5 -a 500 localhost:<span class="token variable">$PORT</span>'</span> -- node 3-server-with-index-in-parallel.js
</code></pre></div><p><img src="https://clinicjs.org/static/f5b4d268888c3f34df7471756935735d/71c55/08-A.png" alt></p> <p>现在我们没有一个单独的 mongodb 查询气泡，而是有两个小的，每个都在顶部的 fastify 气泡的侧面。这要好得多，因为这意味着我们并行执行了更多的异步操作。</p> <blockquote><p>Now instead of having a simple mongodb query bubble we have two tiny ones each flanking our fastify bubble on the top. This is much better as it means we are doing more async operations in parallel.</p></blockquote> <p>从气泡和时间轴上，可以看到总时间下降了三分之一。</p> <blockquote><p>Once again we can see a drop in the total times by further one third. This is reflected both in the bubbles and the timeline.</p></blockquote> <p>就目前而言，这种气泡布局接近最佳。我们几乎没有用户空间代码占用任何时间，这意味着大部分时间花在第三方模块上 - 我们假设我们对它们的使用也是最优的。</p> <blockquote><p>As it stands, this bubble layout is close to optimal. We have almost no userland code taking up any time anymore, which means most time is spent in 3rd party modules - which we assume to be pretty optimal for their usecase as well.</p></blockquote> <p>那么更进一步的改进就是摆脱 mongodb 气泡或 fastify 气泡了。摆脱 fastify 会很难，因为我们的应用程序是一个 http 服务器，而 fastify 已经非常擅长做 http 相关的东西了。为了摆脱 mongodb 气泡，我们将不得不用数据库做更少的事情。</p> <blockquote><p>The main way to improve this now, would be to get rid of the mongodb bubble or fastify bubble entirely. Getting rid of fastify would be hard as our application is a http server and fastify is already really good at doing http stuff. To get rid of the mongodb bubble we would have to do fewer things with the database.</p></blockquote></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Youjingyu/clinic-doc-zh/edit/master/docs/bubbleprof/parallel_queries.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/clinic-doc-zh/bubbleprof/improving_our_latency.html" class="prev">
          改善延迟
        </a></span> <span class="next"><a href="/clinic-doc-zh/bubbleprof/caching_the_results.html">
          缓存结果
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/clinic-doc-zh/assets/js/app.75a44ac4.js" defer></script><script src="/clinic-doc-zh/assets/js/10.b505e73e.js" defer></script>
  </body>
</html>
