<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高级分析</title>
    <meta name="description" content="Node Clinic 中文文档">
    <link rel="shortcut icon" href="/clinic-doc-zh/icon.png">
  <style>
      p + blockquote, ol + blockquote,  ul + blockquote {
        display: none;
      }
    </style>
  <script>
      document.addEventListener('click', function (e) {
        var target = e.target
        var nextSibling
        if (target.tagName === 'P') {
          nextSibling = target.nextElementSibling
        } else if (target.tagName === 'LI') {
          nextSibling = target.parentNode.nextElementSibling
        }
        if (nextSibling && nextSibling.tagName === 'BLOCKQUOTE') {
          var hide = 'display:none'
          var show = 'display:block'
          var style = nextSibling.getAttribute('style')
          nextSibling.setAttribute('style', style === show ? hide : show)
        }
      })
    </script>
  <script>
      var logoUrlChanger = setInterval(function () {
        // Anchor above the logo image
        var homeEls = document.getElementsByClassName('home-link')
        if (homeEls.length > 0) {
          var homeEl = homeEls[0]
          homeEl.setAttribute('href', 'https://clinicjs.org/documentation')
          homeEl.setAttribute('onclick', "document.location='https://clinicjs.org/documentation';return false;")
          clearInterval(logoUrlChanger)
        }

        // Actual logo image
        var logoEls = document.getElementsByClassName('logo')
        if (logoEls.length > 0) {
          var logoEl = logoEls[0]
          logoEl.setAttribute('onclick', "document.location='https://clinicjs.org/documentation';return false;")
          clearInterval(logoUrlChanger)
        }
      }, 1000)
    </script>
    
    <link rel="preload" href="/clinic-doc-zh/assets/css/0.styles.feea2165.css" as="style"><link rel="preload" href="/clinic-doc-zh/assets/js/app.75a44ac4.js" as="script"><link rel="preload" href="/clinic-doc-zh/assets/js/21.9cdae012.js" as="script"><link rel="prefetch" href="/clinic-doc-zh/assets/js/10.b505e73e.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/11.032e2525.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/12.19c3aee9.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/13.9082d8b6.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/14.c6f29cca.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/15.b41e31f0.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/16.841d9223.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/17.55afc7db.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/18.f63d344f.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/19.11585fc4.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/2.e5f43561.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/20.47b55fca.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/22.39d2389b.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/23.2fb2fbba.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/24.1bf5b85a.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/25.4cb5b678.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/26.7f5c2c15.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/27.23216170.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/28.1707d2c7.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/29.7c788ded.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/3.a472746a.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/30.1382df70.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/31.8f6973e1.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/4.7a3df476.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/5.d84f4001.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/6.4af6163d.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/7.91d6fdd6.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/8.c444e8be.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/9.fcb1f222.js">
    <link rel="stylesheet" href="/clinic-doc-zh/assets/css/0.styles.feea2165.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/clinic-doc-zh/" class="home-link router-link-active"><img src="/clinic-doc-zh/logo.png" alt="" class="logo"> <!----></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/Youjingyu/clinic-doc-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/Youjingyu/clinic-doc-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/clinic-doc-zh/" class="sidebar-link">开始</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Doctor</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Flame</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/clinic-doc-zh/flame/preface.html" class="sidebar-link">前言</a></li><li><a href="/clinic-doc-zh/flame/setup.html" class="sidebar-link">安装</a></li><li><a href="/clinic-doc-zh/flame/getting_ready.html" class="sidebar-link">准备</a></li><li><a href="/clinic-doc-zh/flame/first_analysis.html" class="sidebar-link">首次分析</a></li><li><a href="/clinic-doc-zh/flame/flamegraphs.html" class="sidebar-link">火焰图</a></li><li><a href="/clinic-doc-zh/flame/controls.html" class="sidebar-link">控制面板</a></li><li><a href="/clinic-doc-zh/flame/optimizing_a_hot_function.html" class="sidebar-link">优化热函数</a></li><li><a href="/clinic-doc-zh/flame/reducing_the_graph_size.html" class="sidebar-link">减小火焰图大小</a></li><li><a href="/clinic-doc-zh/flame/advanced_analysis.html" class="active sidebar-link">高级分析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/clinic-doc-zh/flame/advanced_controls.html" class="sidebar-link">高级控件</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Bubbleprof</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="高级分析"><a href="#高级分析" aria-hidden="true" class="header-anchor">#</a> 高级分析</h1> <p>在我们最新的火焰图中仍然有一些热块：</p> <blockquote><p>We still have some hot blocks in our latest flamegraph:</p></blockquote> <p><img src="https://clinicjs.org/static/d81062495d5e738b07588125894b8263/65be2/07-A.png" alt></p> <p>没有最热的块涉及到我们的代码，但让我们花点时间思考一下发生了什么。</p> <blockquote><p>None of the hottest blocks refer to any of our code, but let's take a minute to think through what's happening.</p></blockquote> <p>最热块的是 <code>_stream_writable.js</code> 中的 <code>clearBuffer</code>，这是 Node 的核心代码，由于我们的目标不是优化 Node 核心代码，因此我们继续看下一个最热的块：<code>handleRequest</code>。</p> <blockquote><p>The hottest is clearBuffer in _stream_writable.js. This is part of Node core. Since the goal here isn't to begin optimizing Node core, let's look at the next hottest block: handleRequest.</p></blockquote> <p>我们可以展开 <code>handleRequest</code> 块，如下所示：</p> <blockquote><p>We can expand the handleRequest block to look something like the following:</p></blockquote> <p><img src="https://clinicjs.org/static/c387182660b3c2dd9e81143b5f5554ef/65be2/08-A.png" alt></p> <p>看一下这个子视图中最热的三个函数：</p> <blockquote><p>Looking at the three hottest functions in this sub-view:</p></blockquote> <ol><li>Node.js 的 <code>clearBuffer</code> 是第一个，它占用了 <code>onSendEnd</code> 内部的大部分时间。如上所述，优化它可能会很困难。</li></ol> <blockquote><p>Node.js's clearBuffer is first and accounts for most of the time spent inside onSendEnd. As discussed, optimizing that will probably be difficult.</p></blockquote> <ol start="2"><li>第二个最热的是 Fastify 中的函数 <code>handleRequest</code>，它有很多子函数块，所以显然非常复杂。</li></ol> <blockquote><p>Second hottest is the Fastify function handleRequest, which has many children so is clearly quite complex.</p></blockquote> <ol start="3"><li>第三是我们自己的函数 - 但我们已经对其进行了优化。</li></ol> <blockquote><p>Third is in our own payload function - but we've already optimized that.</p></blockquote> <p>那么，为什么在 <code>handleRequest</code> 中花了那么长时间？如果我们点击 <code>copy path</code> 按钮来查看 Fastify 的代码，会发现没有什么明显的问题，因为 Fastify 已经针对性能做了很好的优化。</p> <blockquote><p>So, why are we spending a long time inside handleRequest? If we click copy path to look at the Fastify code, there's nothing obviously wrong, and we know Fastify is quite well optimized for performance.</p></blockquote> <p>是我们遗漏了什么东西吗？让我们打开选项菜单并勾选未选中的 &quot;V8&quot; 按钮，然后火焰图会显示通常隐藏在 V8 JavaScript 引擎内的操作：</p> <blockquote><p>Maybe something is missing? Let's open the Options menu and tick the unticked &quot;V8&quot; button, showing operations inside the V8 JavaScript engine that are normally hidden:</p></blockquote> <p><img src="https://clinicjs.org/static/86862789c949579d6b975ee4a5642c54/65be2/08-B.png" alt></p> <p>火焰图中的间隙几乎完全消失，并出现了一个新的块（上面截图中选中的块），它执行了 <code>T v8::internal::Builtin_JsonStringify</code>。这说明它是 v8 中的 c++ 函数，名为 <code>Builtin_JsonStringify</code>。显然，这与 <code>JSON.stringify()</code> 有关。</p> <blockquote><p>The gap almost completely disappears, and a new block appears (selected in the above screenshot), starting T v8::internal::Builtin_JsonStringify. This means it refers to a C++ function inside V8, named Builtin_JsonStringify. Clearly, this is related to JSON.stringify().</p></blockquote> <p>需要知道的是，我们熟悉的 JavaScript API <code>JSON.stringify()</code>和 <code>JSON.parse()</code> 不是通过 V8 采样，而是直接跳到底层的 C ++ 实现。</p> <blockquote><p>It's worth knowing that the JavaScript wrappers JSON.stringify() and JSON.parse() that we are familiar with are not sampled directly by V8, which instead skips straight to the underlying C++ implementation.</p></blockquote> <p>展开它，我们看到 V8 在对某些 JSON 进行 stringify 时需要执行许多步骤。</p> <blockquote><p>Expand that, and we see V8 needs to do many, many steps when trying to stringify some JSON.</p></blockquote> <p><img src="https://clinicjs.org/static/3ba323f173ed19f21f7ed89568f36154/65be2/08-C.png" alt></p> <p>在这种情况下，我们需要关注一个调用许多微任务的低效父函数，而不是关注一个“热”函数。每个微任务看起来都很快 - 问题是，他们加起来会耗费很多时间。</p> <blockquote><p>This is a case where instead of focussing on one &quot;hot&quot; function, we need to focus on an inefficient parent function that is calling many micro-tasks. Each one looks pretty fast - the problem is, they add up to a lot of time.</p></blockquote> <p>为什么这里会做 JSON 转为字符串的操作？这是因为我们发送了一个对象，Express 和 Fastify 都会自动序列化传递给 send 方法的对象。</p> <blockquote><p>Why is JSON stringification happening here? It's because we send an object, and both Express and Fastify will automatically serialize an object passed to their send method.</p></blockquote> <p>当我们关闭内联优化时，这个瓶颈会变得更加清晰。</p> <blockquote><p>This bottleneck becomes a lot clearer when we turn off inlining.</p></blockquote> <p>运行下面的命令：</p> <blockquote><p>Let's run the following command:</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>clinic flame --on-port <span class="token string">'autocannon localhost:<span class="token variable">$PORT</span>'</span> -- node --no-turbo-inlining 3-server-with-reduced-call-graph.js
</code></pre></div><p>这会生成下面的火焰图：</p> <blockquote><p>This will produce a flamegraph similar to the following:</p></blockquote> <p><img src="https://clinicjs.org/static/b7fcc18a00ca422e08241f7ee7aec38c/0b628/08-D.png" alt></p> <p>我们发现一个新的第二热函数（在 Node 核心代码之后）- <code>serialize</code>，之前由于被 V8 内联而隐藏了。</p> <blockquote><p>We have a new second-hottest function (after the Node core one) - serialize. This was previously hidden due to being inlined by V8.</p></blockquote> <p>由于没有内联函数，<code>serialize</code> 函数变为更加明显的瓶颈。而在内联中，热块更多地位于堆栈的顶部，因为它们代表了其他几个已经内嵌到其中的函数。</p> <blockquote><p>With none of the functions inlining, it becomes a lot more apparent that the serialize function is a bottleneck. Whereas with inlining the hot blocks were seen more on the top of the stack because they represent several other functions that have also been inlined into them.</p></blockquote> <p>在 <code>The 4-server-with-manual-serialization.js</code> 中，将 <code>payload</code> 函数的 23 行的 <code>return {date, id}</code> 修改为：</p> <blockquote><p>The 4-server-with-manual-serialization.js alters the line 23 in the payload function from return {date, id} to:</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">return</span> <span class="token template-string"><span class="token string">`{&quot;date&quot;: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>date<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, &quot;id&quot;: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;}`</span></span>
</code></pre></div><p>值得注意的是，在许多情况下，这种优化可能是不合适的，例如，由于安全问题，必须对输入转义的情况。一种替代手动序列化的方法使用基于 schema 的序列化方案 <a href="http://npm.im/fast-json-stringify" target="_blank" rel="noopener noreferrer">fast-json-stringify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这种方式仍然比使用 <code>JSON.stringify</code> 快。Fastify Web 框架默认支持基于 schema 的序列化，请参阅 <a href="https://github.com/fastify/fastify/blob/master/docs/Validation-and-Serialization.md#serialization" target="_blank" rel="noopener noreferrer">Fastify 的序列化文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <blockquote><p>It should be noted here that this technique may be inappropriate in many cases, for instance where escaping inputs is crucial to security. An alternative to manual serialization which is still faster than using JSON.stringify is schema-based serialization using fast-json-stringify. The Fastify web framework also supports schema-based serialization by default, see Fastify's Serialization Documentation.</p></blockquote> <p>我们再次运行 Clinic Flame 为 <code>4-server-with-manual-serialization.js</code> 生成一个火焰图：</p> <blockquote><p>Let's run Clinic Flame to create a flamegraph for 4-server-with-manual-serialization.js:</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>clinic flame --on-port <span class="token string">'autocannon localhost:<span class="token variable">$PORT</span>'</span> -- node 4-server-with-manual-serialization.js
</code></pre></div><p>结果如下:</p> <blockquote><p>This should give something like:</p></blockquote> <p><img src="https://clinicjs.org/static/caff578ccade06aca99efed3c1a45dff/65be2/08-E.png" alt></p> <p>我们可以看到最热的块是 Node 核心函数 <code>Socket._writeGeneric</code>，它由 <code>clearBuffer</code> 调用。它与之前的 Node 核心瓶颈相同，只是在这个采样周期内，V8 引擎没有将 <code>Socket._writeGeneric</code> 内联到 <code>clearBuffer</code> 中。</p> <blockquote><p>We can see the the hottest block is a Node core function, Socket._writeGeneric, which is called by clearBuffer. It's same Node core bottleneck as before, it's just that in this sampling period the V8 engine didn't inline Socket._writeGeneric into clearBuffer.</p></blockquote> <p>让我们使用 <code>autocannon</code> 来确定它对服务器性能的影响：</p> <blockquote><p>Let's use autocannon to determine the effect this has had on server performance:</p></blockquote> <p><img src="https://clinicjs.org/static/c12e04a80202e977607f373c110ff2d6/366e0/08-F.png" alt></p> <p>可以看到，我们已经实现了大约 10％ 的改进。</p> <blockquote><p>We've achieved roughly another 10% improvement.</p></blockquote> <p>现在，对应用程序的进一步优化变得越来越具有挑战性，因为 Node 核心代码中的函数已成为主要瓶颈。我们还可以在这里、那里挤出几个百分点的性能提升，特别是如果我们愿意改变针对 <code>id</code> 字段的约束。</p> <blockquote><p>At this point further optimization of the application becomes increasingly challenging, since functions in Node core have become the primary bottleneck. A few more percent could be squeezed out here and there, especially if we were willing to change the constraints of the id field.</p></blockquote> <p>但是，在大多数情况下，我们的工作已经完成了。</p> <blockquote><p>However, for the most part, our work here is done.</p></blockquote> <h3 id="下一步"><a href="#下一步" aria-hidden="true" class="header-anchor">#</a> 下一步</h3> <p>练习已经完成。恭喜！你现在应该可以使用 Clinic Flame 来解决常见的性能问题了。</p> <blockquote><p>The walkthrough is complete. Congratulations! You should now be able to use Clinic Flame to solve common performance problems.</p></blockquote> <p>你也可以选择继续阅读有关 Flame <a href="/clinic-doc-zh/flame/advanced_controls.html">高级控件</a>的内容。</p> <blockquote><p>You may also choose to continue to read about Flame's more advanced controls.</p></blockquote></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Youjingyu/clinic-doc-zh/edit/master/docs/flame/advanced_analysis.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/clinic-doc-zh/flame/reducing_the_graph_size.html" class="prev">
          减小火焰图大小
        </a></span> <span class="next"><a href="/clinic-doc-zh/flame/advanced_controls.html">
          高级控件
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/clinic-doc-zh/assets/js/app.75a44ac4.js" defer></script><script src="/clinic-doc-zh/assets/js/21.9cdae012.js" defer></script>
  </body>
</html>
