<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>火焰图</title>
    <meta name="description" content="Node Clinic 中文文档">
    <link rel="shortcut icon" href="/clinic-doc-zh/icon.png">
  <style>
      p + blockquote, ol + blockquote,  ul + blockquote {
        display: none;
      }
    </style>
  <script>
      document.addEventListener('click', function (e) {
        var target = e.target
        var nextSibling
        if (target.tagName === 'P') {
          nextSibling = target.nextElementSibling
        } else if (target.tagName === 'LI') {
          nextSibling = target.parentNode.nextElementSibling
        }
        if (nextSibling && nextSibling.tagName === 'BLOCKQUOTE') {
          var hide = 'display:none'
          var show = 'display:block'
          var style = nextSibling.getAttribute('style')
          nextSibling.setAttribute('style', style === show ? hide : show)
        }
      })
    </script>
  <script>
      var logoUrlChanger = setInterval(function () {
        // Anchor above the logo image
        var homeEls = document.getElementsByClassName('home-link')
        if (homeEls.length > 0) {
          var homeEl = homeEls[0]
          homeEl.setAttribute('href', 'https://clinicjs.org/documentation')
          homeEl.setAttribute('onclick', "document.location='https://clinicjs.org/documentation';return false;")
          clearInterval(logoUrlChanger)
        }

        // Actual logo image
        var logoEls = document.getElementsByClassName('logo')
        if (logoEls.length > 0) {
          var logoEl = logoEls[0]
          logoEl.setAttribute('onclick', "document.location='https://clinicjs.org/documentation';return false;")
          clearInterval(logoUrlChanger)
        }
      }, 1000)
    </script>
    
    <link rel="preload" href="/clinic-doc-zh/assets/css/0.styles.feea2165.css" as="style"><link rel="preload" href="/clinic-doc-zh/assets/js/app.75a44ac4.js" as="script"><link rel="preload" href="/clinic-doc-zh/assets/js/25.4cb5b678.js" as="script"><link rel="prefetch" href="/clinic-doc-zh/assets/js/10.b505e73e.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/11.032e2525.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/12.19c3aee9.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/13.9082d8b6.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/14.c6f29cca.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/15.b41e31f0.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/16.841d9223.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/17.55afc7db.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/18.f63d344f.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/19.11585fc4.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/2.e5f43561.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/20.47b55fca.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/21.9cdae012.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/22.39d2389b.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/23.2fb2fbba.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/24.1bf5b85a.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/26.7f5c2c15.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/27.23216170.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/28.1707d2c7.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/29.7c788ded.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/3.a472746a.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/30.1382df70.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/31.8f6973e1.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/4.7a3df476.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/5.d84f4001.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/6.4af6163d.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/7.91d6fdd6.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/8.c444e8be.js"><link rel="prefetch" href="/clinic-doc-zh/assets/js/9.fcb1f222.js">
    <link rel="stylesheet" href="/clinic-doc-zh/assets/css/0.styles.feea2165.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/clinic-doc-zh/" class="home-link router-link-active"><img src="/clinic-doc-zh/logo.png" alt="" class="logo"> <!----></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/Youjingyu/clinic-doc-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/Youjingyu/clinic-doc-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/clinic-doc-zh/" class="sidebar-link">开始</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Doctor</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Flame</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/clinic-doc-zh/flame/preface.html" class="sidebar-link">前言</a></li><li><a href="/clinic-doc-zh/flame/setup.html" class="sidebar-link">安装</a></li><li><a href="/clinic-doc-zh/flame/getting_ready.html" class="sidebar-link">准备</a></li><li><a href="/clinic-doc-zh/flame/first_analysis.html" class="sidebar-link">首次分析</a></li><li><a href="/clinic-doc-zh/flame/flamegraphs.html" class="active sidebar-link">火焰图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/clinic-doc-zh/flame/flamegraphs.html#函数间的调用关系（调用栈）" class="sidebar-link">函数间的调用关系（调用栈）</a></li><li class="sidebar-sub-header"><a href="/clinic-doc-zh/flame/flamegraphs.html#函数在-cpu-上的执行时间（函数块宽度）" class="sidebar-link">函数在 CPU 上的执行时间（函数块宽度）</a></li><li class="sidebar-sub-header"><a href="/clinic-doc-zh/flame/flamegraphs.html#函数在栈顶的停留时间（热度）" class="sidebar-link">函数在栈顶的停留时间（热度）</a></li></ul></li><li><a href="/clinic-doc-zh/flame/controls.html" class="sidebar-link">控制面板</a></li><li><a href="/clinic-doc-zh/flame/optimizing_a_hot_function.html" class="sidebar-link">优化热函数</a></li><li><a href="/clinic-doc-zh/flame/reducing_the_graph_size.html" class="sidebar-link">减小火焰图大小</a></li><li><a href="/clinic-doc-zh/flame/advanced_analysis.html" class="sidebar-link">高级分析</a></li><li><a href="/clinic-doc-zh/flame/advanced_controls.html" class="sidebar-link">高级控件</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Bubbleprof</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="火焰图"><a href="#火焰图" aria-hidden="true" class="header-anchor">#</a> 火焰图</h1> <p>我们再来看<a href="/clinic-doc-zh/flame/first_analysis.html">上一步</a>中生成的火焰图。</p> <blockquote><p>Let's take a look again at the flamegraph generated in the prior First analysis step.</p></blockquote> <p><img src="https://clinicjs.org/static/60ec54d4c38a25cb8c567ccf71a6c187/65be2/03.png" alt></p> <p>先忽略周围的控制面板，专注于理解可视化部分。</p> <blockquote><p>Ignoring the surrounding controls for the moment, let's focus in on understanding the visualization.</p></blockquote> <p>在生成火焰图时，我们主要关注三个关键问题：</p> <blockquote><p>When generating a flamegraph we are asking three key questions:</p></blockquote> <ul><li>在采样期间，哪些函数相互调用</li></ul> <blockquote><p>During the sampling period, which functions called each other?</p></blockquote> <ul><li>每个函数在 CPU 上的执行时间</li></ul> <blockquote><p>How much time was each function observed on-CPU?</p></blockquote> <ul><li>每个函数在栈顶的停留时间</li></ul> <blockquote><p>How much time was each function observed at the top of the stack?</p></blockquote> <p>这三个问题都可以在可视化部分找到答案。</p> <blockquote><p>These three questions are answered visually.</p></blockquote> <h2 id="函数间的调用关系（调用栈）"><a href="#函数间的调用关系（调用栈）" aria-hidden="true" class="header-anchor">#</a> 函数间的调用关系（调用栈）</h2> <p>下面的图中，每个块都代表一个函数调用，每一块都聚合了该函数导致的调用栈。当一个函数块（译者注：为了方便理解，将 block 翻译为函数块）位于另一个函数块的顶部时，说明它被它下面的函数块调用，下面的函数块又被其下面的函数块调用，依此类推。</p> <blockquote><p>Each block represents the invocations of one function, aggregated by the call stack that led to it. When one block sits on top of another, it was called by the block below it, which was called by the block below it, and so on down the stack.</p></blockquote> <p><img src="https://clinicjs.org/static/c784a05011433eb4418ae85791697da8/c4232/04-A.png" alt></p> <p>在 Clinic Flame 中，使用文本和边框的颜色帮助你区分不同来源的代码。白色表示你正在分析的应用中的代码（即由你控制的代码）。蓝色表示 <code>node_modules</code> 中的代码，而灰色表示 Node.js 本身的核心代码。</p> <blockquote><p>In Clinic Flame, the text and outline colours of each block help you navigate. White represents code in the application being profiled (i.e. code under your direct control). Blue represents your dependencies in node_modules, while grey represents code in Node.js core itself.</p></blockquote> <h2 id="函数在-cpu-上的执行时间（函数块宽度）"><a href="#函数在-cpu-上的执行时间（函数块宽度）" aria-hidden="true" class="header-anchor">#</a> 函数在 CPU 上的执行时间（函数块宽度）</h2> <p>函数块的宽度代表分析期间，函数在 CPU 上的执行时间。但这段时间内，函数不一定在执行自己的代码，如果在它上面还有函数快，说明它调用了上面的函数并等待它执行完成。</p> <blockquote><p>The width of a block represents the amount of time it was on the CPU, out of the duration of the profile run. This does not necessarily mean the function was executing its own code: where there are blocks above it, it had called that function and was waiting for it to complete.</p></blockquote> <p>Clinic Flame 按照函数块的宽度排序，最宽的（执行时间最长的）显示在左边。</p> <blockquote><p>Clinic Flame sorts the functions called by each function so that the widest blocks (the functions spending longest on the CPU) are shown first, on the left.</p></blockquote> <p><img src="https://clinicjs.org/static/cb5f24545b483df675c04a361af12edd/c4232/04-B.png" alt></p> <h2 id="函数在栈顶的停留时间（热度）"><a href="#函数在栈顶的停留时间（热度）" aria-hidden="true" class="header-anchor">#</a> 函数在栈顶的停留时间（热度）</h2> <p>函数在栈顶的停留时间等效于：函数阻塞 Node.js 事件循环的时间。如果一个函数经常停留在栈顶，意味着它花费更多的时间执行自己的代码，而不是调用其他函数或者触发函数回调。</p> <blockquote><p>This can be rephrased as: &quot;For how long was a function blocking the Node.js event loop&quot;. If a function is frequently observed at the top of the stack, it means it is spending more time executing its own code than calling other functions or allowing function callbacks to trigger.</p></blockquote> <p>在 Node.js 中，同一时间只能执行一个函数（排除 Worker thread 等情况），如果花费大量时间执行某个函数，就不能执行其他代码了，包括触发 I/O 回调。这就是“阻塞事件循环”这个词的本质。</p> <blockquote><p>In Node.js, only one function can execute at any one time (ignoring possibilities like Worker threads). If a function takes a long time to execute, nothing else can happen, including the triggering of I/O callbacks. This is the essence of the phrase &quot;blocking the event loop&quot;</p></blockquote> <p>在函数块顶部的亮条的亮度表示函数停留在栈顶时间的百分比。换句话说，越亮（越热）表明执行自己代码的时间越多，从而阻止其他带代码执行。</p> <blockquote><p>The brightness of the bar along the exposed top of a block indicates the percentage of time a function was observed at the top of the stack. In other words, the hotter (or, brighter) a block, the more actual time it was taking to execute its own code, preventing any other code from executing.</p></blockquote> <p><img src="https://clinicjs.org/static/38f13a6ea48ca78ae269acf140dd128d/c4232/04-C.png" alt></p> <p>当一个函数阻塞事件循环的概率高于其他函数时，我们将其称为“热”函数。寻找这些“热”函数就是寻找优化代码的好地方。Clinic Flame 默认选中“最热的”函数，并提供了切换到下一个“热”函数的控制面板。</p> <blockquote><p>When a function is blocking the event loop in higher proportion to other functions we call this a &quot;hot&quot; function. Looking for these &quot;hot&quot; functions is a good place to start looking for places to optimise your code. Clinic Flame by default selects the &quot;hottest&quot; frame, and gives controls to cycle through the next hottest.</p></blockquote></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Youjingyu/clinic-doc-zh/edit/master/docs/flame/flamegraphs.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/clinic-doc-zh/flame/first_analysis.html" class="prev">
          首次分析
        </a></span> <span class="next"><a href="/clinic-doc-zh/flame/controls.html">
          控制面板
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/clinic-doc-zh/assets/js/app.75a44ac4.js" defer></script><script src="/clinic-doc-zh/assets/js/25.4cb5b678.js" defer></script>
  </body>
</html>
